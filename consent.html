<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consent Form</title>
    <style>
        :root {
            --bg: #f5f5f5;
            --card: #fff;
            --text: #333;
            --primary: #2563eb;
            --border: #e5e7eb;
        }
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 2rem 1rem;
            min-height: 100vh;
        }
        .container {
            max-width: 520px;
            margin: 0 auto;
            background: var(--card);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 { margin-top: 0; font-size: 1.25rem; }
        .meta { color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        .choices { display: flex; gap: 1rem; flex-wrap: wrap; }
        .choices label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        input[type="radio"] { margin: 0; }
        textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            font-family: inherit;
        }
        button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            cursor: pointer;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .message { margin-top: 1rem; padding: 0.75rem; border-radius: 0.25rem; }
        .message.error { background: #fef2f2; color: #991b1b; }
        .message.success { background: #f0fdf4; color: #166534; }
        .message.info { background: #eff6ff; color: #1e40af; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="message info">Loading…</div>
        <div id="invalid" style="display: none;">
            <h1>Invalid or expired link</h1>
            <p>This consent link is invalid, has expired, or has already been completed. If you need a new link, please contact your instructor.</p>
        </div>
        <div id="formBox" style="display: none;">
            <h1>Consent form</h1>
            <p class="meta" id="requestMeta"></p>
            <form id="consentForm">
                <div class="form-group">
                    <label>Do you consent?</label>
                    <div class="choices">
                        <label><input type="radio" name="consent" value="yes" required> I consent</label>
                        <label><input type="radio" name="consent" value="no"> I do not consent</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="consentText">Comments (optional)</label>
                    <textarea id="consentText" name="consentText" placeholder="Optional notes"></textarea>
                </div>
                <button type="submit" id="submitBtn">Submit</button>
            </form>
            <div id="formMessage" class="message" style="display: none;"></div>
        </div>
        <div id="done" style="display: none;">
            <h1>Thank you</h1>
            <p>Your response has been recorded.</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            var SUPABASE_URL = window.SUPABASE_URL || 'https://mqhbfefylpfqsbtrshpu.supabase.co';
            var SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'sb_publishable_dypr7H7lUg2JGsvewz3VTQ_uov-ty72';

            var token = null;
            var params = new URLSearchParams(window.location.search);
            var tokenStr = params.get('token');
            if (tokenStr) {
                var m = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.exec(tokenStr);
                if (m) token = tokenStr;
            }

            var loadingEl = document.getElementById('loading');
            var invalidEl = document.getElementById('invalid');
            var formBox = document.getElementById('formBox');
            var doneEl = document.getElementById('done');
            var requestMeta = document.getElementById('requestMeta');
            var consentForm = document.getElementById('consentForm');
            var submitBtn = document.getElementById('submitBtn');
            var formMessage = document.getElementById('formMessage');

            function hideAll() {
                loadingEl.style.display = 'none';
                invalidEl.style.display = 'none';
                formBox.style.display = 'none';
                doneEl.style.display = 'none';
            }

            function showMsg(el, text, className) {
                el.style.display = 'block';
                el.textContent = text;
                el.className = 'message ' + (className || 'info');
            }

            if (!token) {
                hideAll();
                invalidEl.style.display = 'block';
                return;
            }

            var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            supabase.rpc('get_consent_request_by_token', { p_token: token })
                .then(function(res) {
                    hideAll();
                    if (res.error || !res.data || res.data.length === 0) {
                        invalidEl.style.display = 'block';
                        return;
                    }
                    var row = res.data[0];
                    requestMeta.textContent = (row.course_name || 'Course') + ' — ' + (row.student_name || 'Student') + ' — ' + (row.consent_type || 'consent').replace(/_/g, ' ');
                    formBox.style.display = 'block';
                })
                .catch(function(err) {
                    hideAll();
                    invalidEl.style.display = 'block';
                    console.error(err);
                });

            consentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                var consent = document.querySelector('input[name="consent"]:checked');
                var consentText = document.getElementById('consentText').value.trim() || null;
                if (!consent) return;
                var consentGiven = consent.value === 'yes';
                formMessage.style.display = 'none';
                submitBtn.disabled = true;
                supabase.rpc('submit_consent_response', {
                    p_token: token,
                    p_consent_given: consentGiven,
                    p_consent_text: consentText
                }).then(function(res) {
                    if (res.data && res.data.ok) {
                        hideAll();
                        doneEl.style.display = 'block';
                    } else {
                        showMsg(formMessage, res.data && res.data.error ? res.data.error : 'Submission failed.', 'error');
                        submitBtn.disabled = false;
                    }
                }).catch(function(err) {
                    showMsg(formMessage, err.message || 'Submission failed.', 'error');
                    submitBtn.disabled = false;
                });
            });
        })();
    </script>
</body>
</html>
