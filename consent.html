<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Use Consent — Speech Gradebook</title>
    <link href="https://fonts.bunny.net/css?family=Crimson+Pro:400,600,700|Work+Sans:400,500,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #142940;
            --text: #2c3e50;
            --text-light: #6c757d;
            --bg: #fafbfc;
            --card: #ffffff;
            --border: #e1e8ed;
            --success: #28a745;
            --error: #dc3545;
            --heading-font: 'Crimson Pro', serif;
            --body-font: 'Work Sans', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--body-font);
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .page-header .brand {
            font-family: var(--heading-font);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .page-header .brand-sub {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        .container {
            max-width: 560px;
            margin: 0 auto;
            background: var(--card);
            padding: 2rem 2.25rem;
            border-radius: 1rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
        }
        h1 {
            font-family: var(--heading-font);
            font-size: 1.5rem;
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        .meta {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1.25rem;
        }
        .disclosure {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 1.5rem;
            padding: 1rem 1.25rem;
            background: #f1f4f7;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        .choices { display: flex; gap: 1.25rem; flex-wrap: wrap; }
        .choices label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 400;
        }
        input[type="radio"] { margin: 0; accent-color: var(--primary); }
        textarea {
            width: 100%;
            min-height: 88px;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        button:hover:not(:disabled) {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .message {
            margin-top: 1rem;
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
        }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.info { background: #e7f1ff; color: #0c5460; border: 1px solid #b8daff; }
        .invalid-state, .done-state {
            text-align: center;
            padding: 0.5rem 0;
        }
        .invalid-state h1, .done-state h1 { margin-bottom: 0.75rem; }
        .done-state .check {
            display: inline-block;
            width: 48px;
            height: 48px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            line-height: 48px;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="brand">Speech Gradebook</div>
        <div class="brand-sub">Data Use Consent</div>
    </div>
    <div class="container">
        <div id="loading" class="message info">Loading…</div>
        <div id="invalid" class="invalid-state" style="display: none;">
            <h1>Invalid or expired link</h1>
            <p>This consent link is invalid, has expired, or has already been completed. If you need a new link, please contact your instructor.</p>
        </div>
        <div id="formBox" style="display: none;">
            <h1>Data use consent</h1>
            <p class="meta" id="requestMeta"></p>
            <p class="disclosure">Your course and evaluation data may be used for grading, platform and AI improvement, research, and may be shared with or licensed to third parties (e.g., researchers or partners). You can still be evaluated if you do not consent; your data will then be stored only on your instructor’s device and not used for research, improvement, or third-party sharing.</p>
            <form id="consentForm">
                <div class="form-group">
                    <label>Do you consent?</label>
                    <div class="choices">
                        <label><input type="radio" name="consent" value="yes" required> I consent</label>
                        <label><input type="radio" name="consent" value="no"> I do not consent</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="consentText">Comments (optional)</label>
                    <textarea id="consentText" name="consentText" placeholder="Optional notes"></textarea>
                </div>
                <button type="submit" id="submitBtn">Submit</button>
            </form>
            <div id="formMessage" class="message" style="display: none;"></div>
        </div>
        <div id="done" class="done-state" style="display: none;">
            <div class="check" aria-hidden="true">✓</div>
            <h1>Thank you</h1>
            <p>Your response has been recorded.</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            var SUPABASE_URL = window.SUPABASE_URL || 'https://mqhbfefylpfqsbtrshpu.supabase.co';
            var SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'sb_publishable_dypr7H7lUg2JGsvewz3VTQ_uov-ty72';

            var token = null;
            var params = new URLSearchParams(window.location.search);
            var tokenStr = params.get('token');
            if (tokenStr) {
                var m = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.exec(tokenStr);
                if (m) token = tokenStr;
            }

            var loadingEl = document.getElementById('loading');
            var invalidEl = document.getElementById('invalid');
            var formBox = document.getElementById('formBox');
            var doneEl = document.getElementById('done');
            var requestMeta = document.getElementById('requestMeta');
            var consentForm = document.getElementById('consentForm');
            var submitBtn = document.getElementById('submitBtn');
            var formMessage = document.getElementById('formMessage');

            function hideAll() {
                loadingEl.style.display = 'none';
                invalidEl.style.display = 'none';
                formBox.style.display = 'none';
                doneEl.style.display = 'none';
            }

            function showMsg(el, text, className) {
                el.style.display = 'block';
                el.textContent = text;
                el.className = 'message ' + (className || 'info');
            }

            if (!token) {
                hideAll();
                invalidEl.style.display = 'block';
                return;
            }

            var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            supabase.rpc('get_consent_request_by_token', { p_token: token })
                .then(function(res) {
                    hideAll();
                    if (res.error || !res.data || res.data.length === 0) {
                        invalidEl.style.display = 'block';
                        return;
                    }
                    var row = res.data[0];
                    requestMeta.textContent = (row.course_name || 'Course') + ' — ' + (row.student_name || 'Student') + (row.consent_type === 'data_collection' ? ' — Data use (grading, platform improvement, research, third-party sharing)' : ' — ' + (row.consent_type || 'consent').replace(/_/g, ' '));
                    formBox.style.display = 'block';
                })
                .catch(function(err) {
                    hideAll();
                    invalidEl.style.display = 'block';
                    console.error(err);
                });

            consentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                var consent = document.querySelector('input[name="consent"]:checked');
                var consentText = document.getElementById('consentText').value.trim() || null;
                if (!consent) return;
                var consentGiven = consent.value === 'yes';
                formMessage.style.display = 'none';
                submitBtn.disabled = true;
                supabase.rpc('submit_consent_response', {
                    p_token: token,
                    p_consent_given: consentGiven,
                    p_consent_text: consentText
                }).then(function(res) {
                    if (res.data && res.data.ok) {
                        hideAll();
                        doneEl.style.display = 'block';
                    } else {
                        showMsg(formMessage, res.data && res.data.error ? res.data.error : 'Submission failed.', 'error');
                        submitBtn.disabled = false;
                    }
                }).catch(function(err) {
                    showMsg(formMessage, err.message || 'Submission failed.', 'error');
                    submitBtn.disabled = false;
                });
            });
        })();
    </script>
</body>
</html>
